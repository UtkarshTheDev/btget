name: Release and Publish

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for changelog generation

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'

    - name: Install dependencies
      run: bun install

    - name: Type check
      run: bun run typecheck

    - name: Lint
      run: bun run lint

    - name: Build production
      run: bun run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ github.sha }}
        path: dist/
        retention-days: 7
        include-hidden-files: true

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from tag
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Extract changelog for this version
      id: changelog
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        # Extract the changelog section for this version
        if [ -f "CHANGELOG.md" ]; then
          # Get content between this version and the next version header
          CHANGELOG=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details."
          fi
        else
          CHANGELOG="Release version ${VERSION}"
        fi
        # Save to file to preserve formatting
        echo "$CHANGELOG" > release_notes.md

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-${{ github.sha }}
        path: dist/

    - name: Create tarball
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        tar -czf btget-${VERSION}.tar.gz dist/ README.md CHANGELOG.md LICENSE

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        name: Release v${{ steps.get_version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          btget-${{ steps.get_version.outputs.version }}.tar.gz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [build, create-release]
    permissions:
      id-token: write # Required for OIDC
      contents: read # Allow checkout to read repository content
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'

    - name: Install dependencies
      run: bun install

    - name: Build production
      run: bun run build

    - name: Verify package contents
      run: |
        echo "ðŸ“¦ Package contents:"
        npm pack --dry-run

    - name: Publish to npm
      run: npm publish --access public

    - name: Add npm badge comment
      uses: actions/github-script@v7
      with:
        script: |
          const version = '${{ needs.create-release.outputs.version }}';
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `âœ… Successfully published \`btget@${version}\` to npm!\n\nðŸ“¦ Install: \`npm install -g btget\`\nðŸ”— [View on npm](https://www.npmjs.com/package/btget)`
          });

  publish-github-packages:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: [build, create-release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Node.js for GitHub Packages
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@utkarshthedev'

    - name: Install dependencies
      run: bun install

    - name: Build production
      run: bun run build

    - name: Update package.json for GitHub Packages
      run: |
        # Temporarily update package name for GitHub Packages
        node -e "const pkg=require('./package.json'); pkg.name='@utkarshthedev/btget'; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"

    - name: Publish to GitHub Packages
      run: npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true  # Don't fail if already published
